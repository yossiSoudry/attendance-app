# שיפוץ מודול חישוב שכר

## סקירה כללית
שיפוץ מלא של מודול חישוב השכר כך שיציג טבלת סיכום של כל העובדים עם אפשרות פירוט לכל עובד.

---

## חלק 1: שדות עובד חדשים

### שדות להוספה ל-Employee Model:
```prisma
employeeNumber    Int       @unique @default(autoincrement()) // מספר עובד אוטומטי
employmentType    EmploymentType @default(HOURLY) // סוג העסקה: שעתי/חודשי
monthlyRate       Int?      // שכר חודשי ברוטו (באגורות) - רלוונטי רק לחודשי
workDaysPerWeek   Int       @default(5) // ימי עבודה בשבוע (מספר)
travelAllowanceType TravelAllowanceType @default(NONE) // סוג תשלום נסיעות
travelAllowanceAmount Int?  // סכום נסיעות (באגורות)
```

### Enums חדשים:
```prisma
enum EmploymentType {
  HOURLY    // שעתי
  MONTHLY   // חודשי
}

enum TravelAllowanceType {
  NONE      // ללא תשלום נסיעות
  DAILY     // לפי יום עבודה
  MONTHLY   // סכום חודשי קבוע
}
```

---

## חלק 2: מודול חופשה/מחלה

### טבלה חדשה - LeaveRequest:
```prisma
enum LeaveType {
  VACATION  // חופשה
  SICK      // מחלה
}

enum LeaveStatus {
  PENDING   // ממתין לאישור
  APPROVED  // אושר
  PARTIALLY_APPROVED // אושר חלקית
  REJECTED  // נדחה
}

model LeaveRequest {
  id              String      @id @default(uuid()) @db.Uuid
  employeeId      String      @db.Uuid
  leaveType       LeaveType
  startDate       DateTime
  endDate         DateTime
  requestedDays   Int         // מספר ימים שהתבקשו
  approvedDays    Int?        // מספר ימים שאושרו (יכול להיות פחות מהמבוקש)
  status          LeaveStatus @default(PENDING)
  documentUrl     String?     // קישור לאישור מחלה (חובה במחלה)
  employeeNote    String?     // הערת העובד
  managerNote     String?     // הערת המנהל
  approvedById    String?     @db.Uuid
  approvedAt      DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  employee        Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  approvedBy      AdminUser?  @relation(fields: [approvedById], references: [id])

  @@index([employeeId, status])
  @@index([startDate, endDate])
}
```

### UI לעובד:
- כפתור "דיווח חופשה/מחלה" ליד כפתור "דיווח רטרואקטיבי"
- מודל עם:
  - בחירת סוג (חופשה/מחלה)
  - בחירת תאריכים (טווח)
  - העלאת אישור מחלה (חובה אם מחלה)
  - הערה אופציונלית
- בקשות ממתינות מופיעות בהיסטוריה עם תווית "ממתין לאישור"

### UI למנהל:
- הבקשות מופיעות בלשונית משמרות עם אפשרות סינון
- אפשרות לאשר/לדחות/לאשר חלקית
- באישור חלקי - המנהל מזין כמה ימים הוא מאשר

---

## חלק 3: מבנה חדש לדף חישוב שכר

### בחירת תקופה (למעלה):
- סלקט: יום / שבוע / חודש
- ניווט קדימה/אחורה
- תצוגת התאריכים הנבחרים

### טבלת סיכום עובדים:
| עמודה | תיאור |
|-------|-------|
| שם עובד | שם מלא |
| מס' עובד | מספר אוטומטי |
| סה"כ שעות | כולל הכל |
| 100% | שעות רגילות |
| 125% | שעות נוספות ראשונות |
| 150% | שעות נוספות שניות |
| ימי חופשה | שאושרו בתקופה |
| ימי מחלה | שאושרו בתקופה |
| שכר לפני בונוס | חישוב בסיסי |
| בונוסים | סה"כ בונוסים |
| סה"כ | סכום סופי |
| פעולות | הרחבה/כיווץ |

### פירוט בהרחבה (אקורדיון):
- רשימת משמרות/ימי חופשה/מחלה
- כל שורה ניתנת לעריכה/מחיקה
- אותו מודל עריכה כמו בלשונית משמרות

---

## חלק 4: ייצוא לאקסל

### דיאלוג ייצוא:
1. **בחירת עובדים** - מולטי-סלקט עם "בחר הכל"
2. **סוג דוח**:
   - [ ] סיכום כללי - גיליון אחד עם כל העובדים
   - [ ] פירוט לכל עובד - גיליון נפרד לכל עובד
   - ניתן לבחור שניהם

### מבנה גיליון סיכום:
**עמודות קבועות (נתוני עובד):**
- שם העובד
- היקף משרה (חודשי/שעתי)
- תעריף לשעה/לחודש ברוטו
- ימי עבודה בשבוע
- מספר עובד

**עמודות נתונים:**
- ימי עבודה בפועל
- שעות עבודה בפועל (כולל הכל)
- שעות 100%
- שעות 125%
- שעות 150%
- נסיעות (סכום)
- ימי חופשה
- ימי מחלה
- ימי חג
- ימי היעדרות (ריק)
- היעדרויות - שעות (ריק)
- תאריך הפסקת עבודה (ריק)
- סיבת הפסקת עבודה (ריק)
- הערות (ריק)

**שורת סיכום בסוף**

### מבנה גיליון פירוט (לכל עובד):
- שם הגיליון = שם העובד
- פירוט יומי של כל המשמרות

---

## חלק 5: חישוב ימי חג

- ימי חג מחושבים אוטומטית מלוח השנה
- **תנאי**: רק ימים שמוגדרים כ-`isRestDay = true`
- נספרים רק ימים שחלים בימי העבודה הרגילים של העובד

---

## סדר ביצוע מומלץ

### שלב 1: עדכון סכימה
- [ ] הוספת שדות לטבלת Employee
- [ ] יצירת טבלת LeaveRequest
- [ ] הוספת enums חדשים
- [ ] עדכון טופס יצירת/עריכת עובד

### שלב 2: מודול חופשה/מחלה
- [ ] יצירת server actions
- [ ] UI לעובד - כפתור ודיאלוג בקשה
- [ ] UI למנהל - צפייה ואישור בלשונית משמרות
- [ ] סינון בטבלת משמרות

### שלב 3: שיפוץ דף חישוב שכר
- [ ] יצירת server action חדש לטבלת סיכום
- [ ] קומפוננטת בחירת תקופה
- [ ] טבלת סיכום עם אקורדיון
- [ ] שילוב עריכה/מחיקה

### שלב 4: ייצוא
- [ ] דיאלוג ייצוא משופר
- [ ] לוגיקת יצירת אקסל עם מספר גיליונות
- [ ] גיליון סיכום עם שורת סה"כ
